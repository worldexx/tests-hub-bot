import telebot
from telebot import types
from dotenv import load_dotenv
import os

# üëâ –í–°–¢–ê–í–¨ –°–Æ–î–ê –¢–û–ö–ï–ù –°–í–û–ï–ì–û –ë–û–¢–ê
load_dotenv()  # –∑–∞–≥—Ä—É–∂–∞–µ–º .env
BOT_TOKEN = os.getenv("BOT_TOKEN")

bot = telebot.TeleBot(BOT_TOKEN)

# ----- –î–ê–ù–ù–´–ï –¢–ï–°–¢–ê -----

QUIZ = {
    "id": "social_vibe_2025",
    "title": "–ö–∞–∫–æ–π —É —Ç–µ–±—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã–π –≤–∞–π–± –≤ 2025?",
    "questions": [
        {
            "id": 1,
            "text": "–ö–∞–∫ —Ç—ã —Ä–µ–∞–≥–∏—Ä—É–µ—à—å, –∫–æ–≥–¥–∞ —Ç–µ–±–µ –∑–≤–æ–Ω—è—Ç?",
            "options": [
                {"id": "A", "text": "–ü–∞–Ω–∏–∫–∞. –°–º–æ—Ç—Ä—é –Ω–∞ –∑–≤–æ–Ω–æ–∫ 10 —Å–µ–∫—É–Ω–¥.", "score": 2},
                {"id": "B", "text": "–°–±—Ä–∞—Å—ã–≤–∞—é –∏ –ø–∏—à—É ¬´–∞ —á—Ç–æ?¬ª", "score": 3},
                {"id": "C", "text": "–ë–µ—Ä—É —Ç—Ä—É–±–∫—É, –±—É–¥—Ç–æ —ç—Ç–æ –≤–∞–∂–Ω—ã–π –¥–æ–≥–æ–≤–æ—Ä.", "score": 1},
                {"id": "D", "text": "–ò–≥–Ω–æ—Ä–∏—Ä—É—é, –Ω–æ –ø–æ—Ç–æ–º —Å—Ç—ã–¥–Ω–æ.", "score": 0},
            ],
        },
        {
            "id": 2,
            "text": "–ö–∞–∫–æ–π —É —Ç–µ–±—è —Ä–µ–∂–∏–º –ø–µ—Ä–µ–ø–∏—Å–∫–∏?",
            "options": [
                {"id": "A", "text": "–û—Ç–≤–µ—á–∞—é —á–µ—Ä–µ–∑ 0,2 —Å–µ–∫—É–Ω–¥—ã.", "score": 3},
                {"id": "B", "text": "–ß–µ—Ä–µ–∑ 2 —á–∞—Å–∞.", "score": 1},
                {"id": "C", "text": "–ß–µ—Ä–µ–∑ 2 –¥–Ω—è, –Ω–æ –±—É–¥—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –±—ã–ª–æ.", "score": 2},
                {"id": "D", "text": "–ß–µ—Ä–µ–∑ 2 –Ω–µ–¥–µ–ª–∏, –Ω–æ –æ—á–µ–Ω—å —Ç–µ–ø–ª–æ.", "score": 0},
            ],
        },
        {
            "id": 3,
            "text": "–ö–∞–∫–æ–π –∑–≤—É–∫ ‚Äî —Ç–≤–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä?",
            "options": [
                {"id": "A", "text": "–ø–∏–Ω–≥-–ø–∏–Ω–≥-–ø–∏–Ω–≥ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è", "score": 3},
                {"id": "B", "text": "–º–º–º‚Ä¶ –ª–∞–¥–Ω–æ‚Ä¶", "score": 0},
                {"id": "C", "text": "–∫—Ä–∏–Ω–∂-—Ç—Ä—É—Å-—Ç—Ä—É—Å", "score": 1},
                {"id": "D", "text": "–±–∞–∞–∞–º ‚Äî –∏–¥–µ—è!", "score": 2},
            ],
        },
        {
            "id": 4,
            "text": "–ß—Ç–æ —Ç—ã –¥–µ–ª–∞–µ—à—å, –∫–æ–≥–¥–∞ –∫—Ç–æ-—Ç–æ –ª–∞–π–∫–Ω—É–ª —Å—Ç–∞—Ä—É—é —Ñ–æ—Ç–∫—É?",
            "options": [
                {"id": "A", "text": "–î—É–º–∞—é, —á—Ç–æ –æ–Ω —Å–ª–µ–¥–∏—Ç.", "score": 3},
                {"id": "B", "text": "–î—É–º–∞—é, —á—Ç–æ —ç—Ç–æ –æ—à–∏–±–∫–∞.", "score": 0},
                {"id": "C", "text": "–î—É–º–∞—é, —á—Ç–æ —ç—Ç–æ —Å—É–¥—å–±–∞.", "score": 2},
                {"id": "D", "text": "–î—É–º–∞—é, —á—Ç–æ —ç—Ç–æ –ª–æ–≤—É—à–∫–∞.", "score": 1},
            ],
        },
        {
            "id": 5,
            "text": "–ö–∞–∫ —Ç—ã –≤–µ–¥—ë—à—å —Å–µ–±—è –Ω–∞ –≤–µ—á–µ—Ä–∏–Ω–∫–µ?",
            "options": [
                {"id": "A", "text": "–ù–∞–±–ª—é–¥–∞—é, –Ω–æ —É–ª—ã–±–∞—é—Å—å.", "score": 0},
                {"id": "B", "text": "–°—Ç–∞–Ω–æ–≤–ª—é—Å—å –¥—É—à–æ–π –∫–æ–º–ø–∞–Ω–∏–∏.", "score": 3},
                {"id": "C", "text": "–£–±–µ–≥–∞—é –Ω–∞ –∫—É—Ö–Ω—é –∏ –≥–æ–≤–æ—Ä—é —Å –∫–æ—Ç–æ–º.", "score": 1},
                {"id": "D", "text": "–î–µ–ª–∞—é –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –º—É–≤, –∏ –≤—Å–µ –æ–±—Å—É–∂–¥–∞—é—Ç.", "score": 2},
            ],
        },
        {
            "id": 6,
            "text": "–ß—Ç–æ —Ç—ã –∑–∞–∫–∞–∑—ã–≤–∞–µ—à—å –≤ –∫–æ—Ñ–µ–π–Ω–µ, –∫–æ–≥–¥–∞ –Ω–µ –∑–Ω–∞–µ—à—å, —á–µ–≥–æ —Ö–æ—á–µ—à—å?",
            "options": [
                {"id": "A", "text": "–ö–∞–ø—É—á–∏–Ω–æ ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–æ–ª–¥–∞—Ç.", "score": 1},
                {"id": "B", "text": "–õ–∞—Ç—Ç–µ, –ø–æ—Ç–æ–º—É —á—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ.", "score": 0},
                {"id": "C", "text": "–§–ª—ç—Ç —É–∞–π—Ç ‚Äî –±—É–¥—Ç–æ —Ç—ã –∏–∑ –ë–µ—Ä–ª–∏–Ω–∞.", "score": 2},
                {"id": "D", "text": "–ß–∞–π. –ü—Ä–æ—Ç–∏–≤ —Å–∏—Å—Ç–µ–º—ã.", "score": 3},
            ],
        },
        {
            "id": 7,
            "text": "–ö–∞–∫ —Ç—ã —Ñ–ª–∏—Ä—Ç—É–µ—à—å?",
            "options": [
                {"id": "A", "text": "–Ø –ù–ï —Ñ–ª–∏—Ä—Ç—É—é. –Ø ‚Äî –æ—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã.", "score": 0},
                {"id": "B", "text": "–ú–æ–≥—É, –Ω–æ —Å–ª—É—á–∞–π–Ω–æ.", "score": 1},
                {"id": "C", "text": "–ß–µ—Ä–µ–∑ –º–µ–º—ã.", "score": 2},
                {"id": "D", "text": "–£–≤–µ—Ä–µ–Ω–Ω–æ, –Ω–æ —Å—Ç—Ä–∞–Ω–Ω–æ.", "score": 3},
            ],
        },
        {
            "id": 8,
            "text": "–ö–∞–∫ —Ç—ã –≤–µ–¥—ë—à—å —Å–µ–±—è –≤ –Ω–æ–≤–æ–π –∫–æ–º–ø–∞–Ω–∏–∏?",
            "options": [
                {"id": "A", "text": "–ú–æ–ª—á—É, –ø–æ–∫–∞ –Ω–µ –ø–æ—á—É–≤—Å—Ç–≤—É—é –≤–∞–π–±.", "score": 0},
                {"id": "B", "text": "–í—Ö–æ–∂—É –∏ –Ω–∞—á–∏–Ω–∞—é —Ä–æ—Ñ–ª–∏—Ç—å.", "score": 3},
                {"id": "C", "text": "–†–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞—é –º—è–≥–∫–æ.", "score": 1},
                {"id": "D", "text": "–ì–æ–≤–æ—Ä—é —Å—Ç—Ä–∞–Ω–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏ –∑–∞–ø–æ–º–∏–Ω–∞—é—Å—å.", "score": 2},
            ],
        },
        {
            "id": 9,
            "text": "–ö–∞–∫–æ–π —Ç–≤–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è?",
            "options": [
                {"id": "A", "text": "–ö–æ—Ä–æ—Ç–∫–∏–µ —Ñ—Ä–∞–∑—ã.", "score": 0},
                {"id": "B", "text": "–ì–æ–ª–æ—Å–æ–≤—ã–µ –Ω–∞ 2 –º–∏–Ω—É—Ç—ã.", "score": 2},
                {"id": "C", "text": "–ú–µ–º–Ω—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏.", "score": 3},
                {"id": "D", "text": "–ì–ª—É–±–æ–∫–∏–µ –º—ã—Å–ª–∏ –≤ 3 —É—Ç—Ä–∞.", "score": 1},
            ],
        },
        {
            "id": 10,
            "text": "–ß—Ç–æ —Ç—ã —á–∞—â–µ –≤—Å–µ–≥–æ –≥–æ–≤–æ—Ä–∏—à—å –¥—Ä—É–∑—å—è–º?",
            "options": [
                {"id": "A", "text": "–ü–æ—à–ª–∏ –¥–æ–º–æ–π.", "score": 0},
                {"id": "B", "text": "–Ø –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π, –ø—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–ª.", "score": 1},
                {"id": "C", "text": "–°–º–æ—Ç—Ä–∏ –∫–∞–∫–æ–π –º–µ–º.", "score": 3},
                {"id": "D", "text": "–ö–æ—Ä–æ—á–µ‚Ä¶ –µ—Å—Ç—å –∏–¥–µ—è.", "score": 2},
            ],
        },
    ],
    "results": [
        {
            "range": [0, 8],
            "title": "–¢–∏—Ö–∏–π –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å",
            "description": "–°–ø–æ–∫–æ–π–Ω—ã–π, –º—è–≥–∫–∏–π, —Å–æ—Ü–∏–∞–ª—å–Ω–æ —Ç–æ—á–Ω—ã–π. –í –∫–æ–º–ø–∞–Ω–∏–∏ ‚Äî —á–µ–ª–æ–≤–µ–∫-—É—é—Ç.",
        },
        {
            "range": [9, 14],
            "title": "–°–æ—Ü–∏–∞–ª—å–Ω—ã–π –•–∞–æ—Å-–ì–µ–Ω–∏–π",
            "description": "–ü–æ—è–≤–ª—è–µ—à—å—Å—è –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ, –º–µ–Ω—è–µ—à—å –≤–∞–π–± –∫–æ–º–Ω–∞—Ç—ã, –∏—Å—á–µ–∑–∞–µ—à—å. –°—Ç—Ä–∞–Ω–Ω–æ —Ö–∞—Ä–∏–∑–º–∞—Ç–∏—á–Ω—ã–π –∏ –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π.",
        },
        {
            "range": [15, 20],
            "title": "–ú–µ–º–Ω—ã–π –ö–æ–º–º—É–Ω–∏–∫–∞—Ç–æ—Ä",
            "description": "–†–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞–µ—à—å –º–µ–º–∞–º–∏, –¥—É–º–∞–µ—à—å –º–µ–º–∞–º–∏ –∏ —Ñ–ª–∏—Ä—Ç—É–µ—à—å –º–µ–º–∞–º–∏. –ß–µ–ª–æ–≤–µ–∫-–≤–∞–π–± —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏.",
        },
        {
            "range": [21, 30],
            "title": "–£–≤–µ—Ä–µ–Ω–Ω—ã–π –ò–Ω—Ç—Ä–æ–≤–µ—Ä—Ç",
            "description": "–ù–µ –ª—é–±–∏—à—å –ª–∏—à–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã, –Ω–æ —É–º–µ–µ—à—å –≤–∫–ª—é—á–∞—Ç—å —Ö–∞—Ä–∏–∑–º—É –≤ –Ω—É–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç. –¢–æ—á–Ω—ã–π, —Ä–µ–¥–∫–∏–π —Ç–∏–ø.",
        },
    ],
}

# ----- –•–†–ê–ù–ï–ù–ò–ï –°–ï–°–°–ò–ô –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô -----

# sessions[chat_id] = {"index": int, "score": int}
sessions = {}


# ----- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò -----

def start_quiz(chat_id: int):
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ—Å—Å–∏—é –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å."""
    sessions[chat_id] = {"index": 0, "score": 0}
    send_question(chat_id)


def send_question(chat_id: int):
    session = sessions.get(chat_id)
    if not session:
        return

    idx = session["index"]
    questions = QUIZ["questions"]

    # –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if idx >= len(questions):
        finish_quiz(chat_id)
        return

    question = questions[idx]

    markup = types.ReplyKeyboardMarkup(
        resize_keyboard=True, one_time_keyboard=True
    )
    for opt in question["options"]:
        # –∫–Ω–æ–ø–∫–∞ = —Ç–µ–∫—Å—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞
        markup.add(types.KeyboardButton(opt["text"]))

    text = f"–í–æ–ø—Ä–æ—Å {idx + 1}/{len(questions)}\n\n{question['text']}"
    bot.send_message(chat_id, text, reply_markup=markup)


def finish_quiz(chat_id: int):
    session = sessions.get(chat_id)
    if not session:
        return

    score = session["score"]

    # –ø–æ–¥–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É
    result_text = f"–¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {score} –±–∞–ª–ª–æ–≤"
    for res in QUIZ["results"]:
        low, high = res["range"]
        if low <= score <= high:
            result_text = f"–¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: *{res['title']}*\n\n{res['description']}"
            break

    bot.send_message(chat_id, result_text, parse_mode="Markdown")
    # —á–∏—Å—Ç–∏–º —Å–µ—Å—Å–∏—é
    sessions.pop(chat_id, None)


# ----- –•–ï–ù–î–õ–ï–†–´ –ë–û–¢–ê -----

@bot.message_handler(commands=["start"])
def handle_start(message: types.Message):
    text = (
        "–ü—Ä–∏–≤–µ—Ç! –Ø tests-hub-bot üëã\n\n"
        "–°–µ–π—á–∞—Å –∑–∞–ø—É—â—É —Ç–µ—Å—Ç:\n"
        f"¬´{QUIZ['title']}¬ª\n\n"
        "–ù–∞–ø–∏—à–∏ /quiz, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å."
    )
    bot.send_message(message.chat.id, text)


@bot.message_handler(commands=["quiz"])
def handle_quiz_command(message: types.Message):
    bot.send_message(
        message.chat.id,
        "–û–∫–µ–π, –ø–æ–≥–Ω–∞–ª–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —Ç–µ—Å—Ç ü§ñ",
        reply_markup=types.ReplyKeyboardRemove(),
    )
    start_quiz(message.chat.id)


@bot.message_handler(func=lambda m: m.chat.id in sessions)
def handle_quiz_answer(message: types.Message):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç—ã —Ç–æ–ª—å–∫–æ —Ç–µ—Ö, —É –∫–æ–≥–æ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è."""
    chat_id = message.chat.id
    session = sessions.get(chat_id)
    if not session:
        return

    idx = session["index"]
    question = QUIZ["questions"][idx]

    # –∏—â–µ–º –≤–∞—Ä–∏–∞–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ø–æ —Ç–µ–∫—Å—Ç—É
    selected = None
    for opt in question["options"]:
        if opt["text"] == message.text:
            selected = opt
            break

    if not selected:
        bot.send_message(chat_id, "–í—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö üëá")
        return

    # –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–ª –∏ –¥–≤–∏–≥–∞–µ–º –∏–Ω–¥–µ–∫—Å
    session["score"] += selected["score"]
    session["index"] += 1

    # –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    send_question(chat_id)


# ----- –ó–ê–ü–£–°–ö –ë–û–¢–ê -----

if __name__ == "__main__":
    print("Bot is running...")
    bot.infinity_polling()
